name: Build and Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      easytier_version:
        description: 'EasyTier version to bundle'
        required: false
        default: '1.2.1'

env:
  GO_VERSION: '1.21'
  NODE_VERSION: '20'
  EASYTIER_VERSION: ${{ github.event.inputs.easytier_version || '1.2.1' }}

jobs:
  # ===== 构建前端 =====
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: netpanel/frontend/package-lock.json

      - name: Install dependencies
        working-directory: netpanel/frontend
        run: npm ci

      - name: Build frontend
        working-directory: netpanel/frontend
        run: npm run build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: netpanel/backend/embed/dist/
          retention-days: 1

  # ===== 下载 EasyTier 二进制 =====
  download-easytier:
    name: Download EasyTier (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: x86_64
            bin: easytier-core
            ext: tar.gz
          - os: linux
            arch: aarch64
            bin: easytier-core
            ext: tar.gz
          - os: windows
            arch: x86_64
            bin: easytier-core.exe
            ext: zip
          - os: windows
            arch: aarch64
            bin: easytier-core.exe
            ext: zip
          - os: macos
            arch: x86_64
            bin: easytier-core
            ext: tar.gz
          - os: macos
            arch: aarch64
            bin: easytier-core
            ext: tar.gz
    steps:
      - name: Download EasyTier binary
        run: |
          VERSION="${{ env.EASYTIER_VERSION }}"
          OS="${{ matrix.os }}"
          ARCH="${{ matrix.arch }}"
          EXT="${{ matrix.ext }}"
          BIN="${{ matrix.bin }}"
          BASE_URL="https://github.com/EasyTier/EasyTier/releases/download/v${VERSION}"
          ARCHIVE="easytier-${OS}-${ARCH}-v${VERSION}.${EXT}"

          echo "Downloading: ${BASE_URL}/${ARCHIVE}"
          curl -fsSL --retry 3 --retry-delay 5 "${BASE_URL}/${ARCHIVE}" -o "easytier.${EXT}"

          if [ "${EXT}" = "zip" ]; then
            unzip -j "easytier.${EXT}" "*/easytier-core.exe" -d ./ 2>/dev/null || \
            unzip -j "easytier.${EXT}" "easytier-core.exe" -d ./ 2>/dev/null || \
            unzip "easytier.${EXT}" && find . -name "easytier-core.exe" -exec cp {} ./ \;
          else
            tar -xzf "easytier.${EXT}" --wildcards "*/easytier-core" --strip-components=1 2>/dev/null || \
            tar -xzf "easytier.${EXT}" "easytier-core" 2>/dev/null || \
            (tar -xzf "easytier.${EXT}" && find . -name "easytier-core" -not -path "./easytier-core" -exec cp {} ./ \;)
            chmod +x "${BIN}"
          fi

          ls -la "${BIN}"
          echo "EasyTier ${VERSION} for ${OS}-${ARCH} downloaded successfully"

      - name: Upload EasyTier artifact
        uses: actions/upload-artifact@v4
        with:
          name: easytier-${{ matrix.os }}-${{ matrix.arch }}
          path: ${{ matrix.bin }}
          retention-days: 1

  # ===== 构建后端（Linux / Windows 交叉编译）=====
  build-linux-windows:
    name: Build (${{ matrix.goos }}-${{ matrix.goarch }})
    runs-on: ubuntu-latest
    needs: [build-frontend, download-easytier]
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
            et_os: linux
            et_arch: x86_64
            et_bin: easytier-core
            cc: gcc
            output: netpanel
            pkg_ext: tar.gz
          - goos: linux
            goarch: arm64
            et_os: linux
            et_arch: aarch64
            et_bin: easytier-core
            cc: aarch64-linux-gnu-gcc
            output: netpanel
            pkg_ext: tar.gz
          - goos: windows
            goarch: amd64
            et_os: windows
            et_arch: x86_64
            et_bin: easytier-core.exe
            cc: x86_64-w64-mingw32-gcc
            output: netpanel.exe
            pkg_ext: zip
          - goos: windows
            goarch: arm64
            et_os: windows
            et_arch: aarch64
            et_bin: easytier-core.exe
            # Windows arm64 使用 llvm-mingw 工具链
            cc: aarch64-w64-mingw32-gcc
            output: netpanel.exe
            pkg_ext: zip

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: netpanel/backend/go.sum

      - name: Download frontend dist
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: netpanel/backend/embed/dist/

      - name: Download EasyTier binary
        uses: actions/download-artifact@v4
        with:
          name: easytier-${{ matrix.et_os }}-${{ matrix.et_arch }}
          path: easytier-bin/

      - name: Install cross-compile toolchains
        run: |
          sudo apt-get update -qq
          PKGS="gcc"
          if [ "${{ matrix.goarch }}" = "arm64" ] && [ "${{ matrix.goos }}" = "linux" ]; then
            PKGS="${PKGS} gcc-aarch64-linux-gnu"
          fi
          if [ "${{ matrix.goos }}" = "windows" ] && [ "${{ matrix.goarch }}" = "amd64" ]; then
            PKGS="${PKGS} gcc-mingw-w64-x86-64"
          fi
          if [ "${{ matrix.goos }}" = "windows" ] && [ "${{ matrix.goarch }}" = "arm64" ]; then
            # 安装 llvm-mingw 用于 Windows arm64 交叉编译
            PKGS="${PKGS} gcc-mingw-w64"
            # 尝试安装 llvm-mingw（如果可用）
            sudo apt-get install -y ${PKGS} || true
            # 下载 llvm-mingw 工具链
            LLVM_MINGW_VER="20231128"
            curl -fsSL "https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VER}/llvm-mingw-${LLVM_MINGW_VER}-ucrt-ubuntu-20.04-x86_64.tar.xz" \
              -o /tmp/llvm-mingw.tar.xz
            sudo tar -xJf /tmp/llvm-mingw.tar.xz -C /opt/
            sudo ln -sf /opt/llvm-mingw-${LLVM_MINGW_VER}-ucrt-ubuntu-20.04-x86_64/bin/aarch64-w64-mingw32-gcc \
              /usr/local/bin/aarch64-w64-mingw32-gcc
            exit 0
          fi
          sudo apt-get install -y ${PKGS}

      - name: Build backend
        working-directory: netpanel/backend
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
          CC: ${{ matrix.cc }}
        run: |
          BUILD_TIME=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
          VERSION="${{ github.ref_name }}"
          [ -z "${VERSION}" ] && VERSION="dev"
          go build \
            -ldflags="-s -w -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME}" \
            -o ../../dist/${{ matrix.output }} .

      - name: Prepare release package
        run: |
          PKG_NAME="netpanel-${{ matrix.goos }}-${{ matrix.goarch }}"
          PKG_DIR="release/${PKG_NAME}"
          mkdir -p "${PKG_DIR}/bin"

          cp "dist/${{ matrix.output }}" "${PKG_DIR}/"
          cp "easytier-bin/${{ matrix.et_bin }}" "${PKG_DIR}/bin/"
          chmod +x "${PKG_DIR}/bin/${{ matrix.et_bin }}" 2>/dev/null || true

          # 写入版本信息文件
          echo "NetPanel ${{ github.ref_name }}" > "${PKG_DIR}/VERSION"
          echo "Built: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "${PKG_DIR}/VERSION"
          echo "Platform: ${{ matrix.goos }}/${{ matrix.goarch }}" >> "${PKG_DIR}/VERSION"
          echo "EasyTier: v${{ env.EASYTIER_VERSION }}" >> "${PKG_DIR}/VERSION"

          cd release
          if [ "${{ matrix.pkg_ext }}" = "zip" ]; then
            zip -r "${PKG_NAME}.zip" "${PKG_NAME}/"
          else
            tar -czf "${PKG_NAME}.tar.gz" "${PKG_NAME}/"
          fi
          ls -lh

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            release/*.tar.gz
            release/*.zip
          retention-days: 7

  # ===== 构建后端（macOS 原生编译）=====
  build-macos:
    name: Build (darwin-${{ matrix.goarch }})
    runs-on: macos-latest
    needs: [build-frontend, download-easytier]
    strategy:
      fail-fast: false
      matrix:
        include:
          - goarch: amd64
            et_arch: x86_64
            output: netpanel
          - goarch: arm64
            et_arch: aarch64
            output: netpanel

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: netpanel/backend/go.sum

      - name: Download frontend dist
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: netpanel/backend/embed/dist/

      - name: Download EasyTier binary
        uses: actions/download-artifact@v4
        with:
          name: easytier-macos-${{ matrix.et_arch }}
          path: easytier-bin/

      - name: Build backend
        working-directory: netpanel/backend
        env:
          GOOS: darwin
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
        run: |
          BUILD_TIME=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
          VERSION="${{ github.ref_name }}"
          [ -z "${VERSION}" ] && VERSION="dev"
          go build \
            -ldflags="-s -w -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME}" \
            -o ../../dist/${{ matrix.output }} .

      - name: Prepare release package
        run: |
          PKG_NAME="netpanel-darwin-${{ matrix.goarch }}"
          PKG_DIR="release/${PKG_NAME}"
          mkdir -p "${PKG_DIR}/bin"

          cp "dist/${{ matrix.output }}" "${PKG_DIR}/"
          cp "easytier-bin/easytier-core" "${PKG_DIR}/bin/"
          chmod +x "${PKG_DIR}/bin/easytier-core"

          echo "NetPanel ${{ github.ref_name }}" > "${PKG_DIR}/VERSION"
          echo "Built: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "${PKG_DIR}/VERSION"
          echo "Platform: darwin/${{ matrix.goarch }}" >> "${PKG_DIR}/VERSION"
          echo "EasyTier: v${{ env.EASYTIER_VERSION }}" >> "${PKG_DIR}/VERSION"

          cd release
          tar -czf "${PKG_NAME}.tar.gz" "${PKG_NAME}/"
          ls -lh

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-darwin-${{ matrix.goarch }}
          path: release/*.tar.gz
          retention-days: 7

  # ===== 发布 Release =====
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-linux-windows, build-macos]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all release artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          path: release/
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: List release files
        run: ls -lh release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*.tar.gz
            release/*.zip
            release/SHA256SUMS.txt
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
          body: |
            ## NetPanel ${{ github.ref_name }}

            ### 下载说明

            | 平台 | 架构 | 文件 |
            |------|------|------|
            | Linux | x86_64 | `netpanel-linux-amd64.tar.gz` |
            | Linux | ARM64 | `netpanel-linux-arm64.tar.gz` |
            | Windows | x86_64 | `netpanel-windows-amd64.zip` |
            | Windows | ARM64 | `netpanel-windows-arm64.zip` |
            | macOS | Intel | `netpanel-darwin-amd64.tar.gz` |
            | macOS | Apple Silicon | `netpanel-darwin-arm64.tar.gz` |

            ### 快速开始

            ```bash
            # Linux/macOS
            tar -xzf netpanel-linux-amd64.tar.gz
            cd netpanel-linux-amd64
            ./netpanel

            # Windows
            # 解压 netpanel-windows-amd64.zip 后运行 netpanel.exe
            ```

            > 默认监听端口：`8080`，首次启动请访问 `http://localhost:8080` 完成初始化。

            ### 校验文件完整性

            ```bash
            sha256sum -c SHA256SUMS.txt
            ```